@page "/register"
@inject HttpClient HttpClient
@inject IAlertService AlertService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<EditForm Model="@UserDTO" OnValidSubmit="HandleValidSubmitAsync">
<DataAnnotationsValidator/>
    <MudCard Elevation="20" Style="min-width: 400px;">
        <MudCardContent>
            <MudStack Row="true">
            <MudTextField Label="Name"
                            @bind-Value="UserDTO.Name" For="@(() => UserDTO.Name)"/>
            <MudTextField Label="Surname"
                          @bind-Value="UserDTO.Surname" For="@(() => UserDTO.Surname)" />
            </MudStack>
            <MudStack Row="true">
                <MudTextField Label="Username" @bind-Value="UserDTO.Username" For="@(() => UserDTO.Username)" />
                <MudTextField Label="Email" @bind-Value="UserDTO.Email" For="@(() => UserDTO.Email)" />
            </MudStack>
            <MudTextField Label="Password" @bind-Value="UserDTO.Password" For="@(() => UserDTO.Password)" InputType="InputType.Password" />
            <MudTextField Label="Repeat password" @bind-Value="UserDTO.RepeatPassword" For="@(() => UserDTO.RepeatPassword)" InputType="InputType.Password" />
            <MudDatePicker Label="Date of birth" @bind-Date="UserDTO.BirthDate" For="@(() => UserDTO.BirthDate)" />
            <MudText Color="Color.Error">@_errorMessage</MudText>
        </MudCardContent>
        <MudCardActions Class="justify-center">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Register</MudButton>
        </MudCardActions>
    </MudCard>
    <MudCard Elevation="20" Style="min-width: 400px;" Class="mt-3">
        <MudCardContent Class="d-flex justify-center">
            <MudText Typo="Typo.h6">Already registered?</MudText>
        </MudCardContent>
        <MudCardActions Class="justify-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@OnLoginClick">Login</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>
    @code {
    [Parameter]
    public RegisterUserDTO UserDTO { get; set; }
    private string _errorMessage;
    protected override void OnInitialized()
    {
        UserDTO = new RegisterUserDTO();
    }

    private async Task HandleValidSubmitAsync()
    {
        var response = await HttpClient.PostAsJsonAsync("api/authentication/register", UserDTO);


        if (response.IsSuccessStatusCode)
        {
            ((UserAuthenticationStateProvider)AuthenticationStateProvider).AuthenticateUser();
            NavigationManager.NavigateTo("/");
        }
        else
        {
            _errorMessage = "Such username already exists, try again";
            AlertService.DisplayAlert(_errorMessage, Severity.Error);
        }
    }

    private void OnLoginClick()
    {
        NavigationManager.NavigateTo("/login");
    }
}